(()=>{"use strict";var e={386:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DomUtil=void 0;const s=n(507);class r{static setStyles(e,t){Object.assign(e.style,t)}static setMouseDragListener(e,t,n){let s=null,r=null;if("object"==typeof e){const i=e;e=i.move,t=i.up,s=i.leave,n=i.useCapture,r=null==s?null:i.leaveTarget||document}const i=()=>{document.removeEventListener("mousemove",e,n),document.removeEventListener("mouseup",o,n),document.removeEventListener("touchmove",e,n),document.removeEventListener("touchend",o,n),a&&r&&(r.removeEventListener("mouseleave",a,n),r.removeEventListener("touchcancel",a,n))},o=e=>{t&&t(e),i()},a=null==s?null:e=>{s&&s(e)&&i()};document.addEventListener("mousemove",e,n),document.addEventListener("mouseup",o,n),document.addEventListener("touchmove",e,n),document.addEventListener("touchend",o,n),a&&r&&(r.addEventListener("mouseleave",a,n),r.addEventListener("touchcancel",a,n))}static getMousePosIn(e,t){const n=t.getBoundingClientRect(),s=document.body.scrollLeft,r=document.body.scrollTop,i=e.changedTouches;let o,a;if(i){const e=i[0];if(0!==e.identifier)return null;o=e.clientX,a=e.clientY}else{const t=e;o=t.pageX,a=t.pageY}return[o-n.left-s,a-n.top-r]}static createCanvas(e,t){const n=document.createElement("canvas");return n.width=e,n.height=t,n}static makeDraggable(e){const t=t=>{if("mousedown"===t.type&&0!==t.button)return!1;const n=document.body.getBoundingClientRect();t.preventDefault();const[i,o]=r.getMousePosIn(t,e),a=-i,l=-o,c=e.getBoundingClientRect(),u=c.width,d=c.height,m={x:i,y:o};return r.setMouseDragListener({move:t=>{const i=r.getMousePosIn(t,e.parentNode);null!=i&&(m.x=s.Util.clamp(i[0]+a,0,Math.floor(n.width-u)),m.y=s.Util.clamp(i[1]+l,0,Math.floor(n.height-d)),r.setStyles(e,{left:`${Math.round(m.x)}px`,top:`${Math.round(m.y)}px`}))},up:e=>{}}),!0};e.addEventListener("mousedown",t),e.addEventListener("touchstart",t)}static addDivButton(e,t){const n=document.createElement("div");return r.setStyles(n,{position:"absolute",right:0,top:0}),n.addEventListener("click",t),n.addEventListener("mousedown",(e=>0===e.button&&(e.stopPropagation(),!0))),n.addEventListener("touchstart",t),e.appendChild(n),n}static putOnCenter(e){const t=document.body.getBoundingClientRect(),n=e.getBoundingClientRect(),i=n.width,o=n.height,a=s.Util.clamp(.5*(t.width-i),0,Math.floor(t.width-i)),l=s.Util.clamp(.5*(t.height-o),0,Math.floor(t.height-o));r.setStyles(e,{left:`${Math.round(a)}px`,top:`${Math.round(l)}px`})}}t.DomUtil=r},949:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FileSystem=t.WaStorage=void 0;const s=n(507),r={0:"r",1:"w",2:"w+",769:"w"};t.WaStorage=class{constructor(){this.files={}}putFile(e,t){"string"==typeof t&&(t=s.Util.encode(t)),console.assert(t.constructor===Uint8Array,t),this.files[e]=t}getFile(e){return this.files[e]}contains(e){return e in this.files}},t.FileSystem=class{constructor(e){this.storage=e,this.fileDescs=["stdin","stdout","stderr"]}saveFile(e,t){this.storage.putFile(e,t)}loadFile(e){return this.storage.getFile(e)}open(e,t,n){if(null==e||0===e.length)return-1;if(0==(3&t)&&!this.storage.contains(e))return-1;null==r[t]&&(console.error(`Unsupported open flag: ${t}`),process.exit(1));const s=this.allocFd(),i={absPath:e,rp:0};return 0!=(3&t)&&(i.write=[],i.writeTotal=0),this.fileDescs[s]=i,s}close(e){return null==this.fileDescs[e]?-1:(this.commitDesc(e),this.fileDescs[e]=null,0)}read(e,t){if(e<0||e>=this.fileDescs.length)return 0;const n=this.fileDescs[e];if(null==n)return 0;const s=null!=n.absPath?this.storage.getFile(n.absPath):n.written;if(null==s||n.rp>=s.length)return 0;const r=Math.min(s.length,n.rp+t.length);t.set(s.subarray(n.rp,r));const i=r-n.rp;return n.rp=r,i}write(e,t){if(e<0||e>=this.fileDescs.length)return 0;if(e<3){const n=s.Util.decodeString(t,0,t.length);return 1!==e&&2!==e||s.Util.putTerminal(n),t.length}const n=this.fileDescs[e];return null==n?0:(n.write.push(t.slice(0)),n.writeTotal+=t.byteLength,t.length)}lseek(e,t,n){const s=this.fileDescs[e];if(null==s)return-1;let r;switch(this.commitDesc(e),n){default:case 0:r=t;break;case 1:r=this.fileDescs[e].position+t;break;case 2:console.assert(!1,"TODO: Implement")}return s.rp=r,r}tmpfile(){const e=this.allocFd();return this.fileDescs[e]={absPath:null,rp:0,write:[],writeTotal:0},e}allocFd(){const e=this.fileDescs.length;for(let t=0;t<e;++t)if(null==this.fileDescs[t])return t;return this.fileDescs.push(null),e}commitDesc(e){if(0<=e&&e<this.fileDescs.length){const t=this.fileDescs[e];if(null!=t&&null!=t.write&&t.write.length>0){const e=new Uint8Array(t.writeTotal);let n=0;for(let s=0;s<t.write.length;++s){const r=t.write[s];new Uint8Array(e.buffer,n,r.byteLength).set(r),n+=r.byteLength}null!=t.absPath?this.saveFile(t.absPath,e):t.written=e,t.write.length=0}}}}},697:(e,t,n)=>{const s=n(386),r=n(507),i=n(695),o=n(949),a=new(ace.require("ace/ext/split").Split)(document.getElementById("editor"));a.setOrientation(a.BESIDE),a.setSplits(2),a.setFontSize(16);const l=ace.require("ace/undomanager").UndoManager,c=(()=>{const e=a.getEditor(0);e.$blockScrolling=1/0,e.setOptions({tabSize:2,useSoftTabs:!0,printMarginColumn:!1}),e.setTheme("ace/theme/monokai"),e.getSession().setMode("ace/mode/c_cpp"),e.renderer.$cursorLayer.setBlinking(!0),e.container.classList.add("code-editor");const t=document.getElementById("default-code");t&&e.setValue(t.innerText.trim()+"\n",-1),e.gotoLine(0,0),e.focus();const n=new l;return e.getSession().setUndoManager(n),e.commands.addCommands([{Name:"Undo",bindKey:{win:"Ctrl-Z",mac:"Command-Z"},exec:e=>e.session.getUndoManager().undo()},{Name:"Redo",bindKey:{win:"Ctrl-Shift-Z",mac:"Command-Shift-Z"},exec:e=>e.session.getUndoManager().redo()}]),e})(),u=(()=>{const e=a.getEditor(1);return e.$blockScrolling=1/0,e.setOptions({tabSize:2,useSoftTabs:!0,printMarginColumn:!1}),e.setReadOnly(!0),e.getSession().setMode("ace/mode/text"),e.setValue("XCC browser version.\n",-1),e})();r.Util.setTerminal(u),window.addEventListener("load",(()=>{const e=new o.WaStorage;let t;async function n(){if(null==t)return;let n;r.Util.clearTerminal(),c.focus();try{if(n=await async function(n){const s="main.c",r=new i.WaProc(e);r.chdir("/home/wasm"),r.saveFile(s,n);const o=["cc","-I/usr/include","-emain",s,"/usr/lib/lib.c"];return 0!==await r.runWasmMain(t,o)?null:r.loadFile("a.wasm")}(c.getValue()),null==n)return}catch(e){return void(e instanceof i.ExitCalledError||r.Util.putTerminalError(e))}const o=new i.WaProc(e);o.registerCFunction("showGraphic",((e,t,n)=>{const r=s.DomUtil.createCanvas(e,t);s.DomUtil.setStyles(r,{display:"block"}),function(e,t,n){const s=e.getContext("2d"),r=s.getImageData(0,0,e.width,e.height);r.data.set(new Uint8Array(t.buffer,n,e.width*e.height*4)),s.putImageData(r,0,0)}(r,o.getLinearMemory(),n);const i=document.createElement("div");i.className="wnd draggable",s.DomUtil.setStyles(i,{zIndex:1e4}),i.appendChild(r),s.DomUtil.makeDraggable(i),s.DomUtil.addDivButton(i,(()=>{var e;null===(e=i.parentNode)||void 0===e||e.removeChild(i)})).className="close-button",document.body.appendChild(i),s.DomUtil.putOnCenter(i)}));const a=document.getElementById("args").value.trim(),l=""===a?[]:a.trim().split(/\s+/);l.unshift("a.wasm");try{const e=await o.runWasmMain(n,l);0!=e&&console.error(`Exit code=${e}`)}catch(e){return void(e instanceof i.ExitCalledError||r.Util.putTerminalError(e))}}r.Util.loadFromServer("libs.json").then((t=>{!function t(n,s){for(const r of Object.keys(s)){const i=`${n}/${r}`;"string"==typeof s[r]?e.putFile(i,s[r]):t(i,s[r])}}("",JSON.parse(t))})),r.Util.loadFromServer("cc.wasm",{binary:!0}).then((e=>t=new Uint8Array(e))),document.getElementById("run").addEventListener("click",n),c.commands.addCommands([{Name:"Run",bindKey:{win:"Ctrl-Enter",mac:"Command-Enter"},exec:e=>n()},{name:"Save",bindKey:{win:"Ctrl-S",mac:"Command-S",sender:"editor|cli"},exec:function(e,t,n){alert("Saved!")}}]),window.addEventListener("resize",(()=>{console.log("resize"),a.resize()}),!1)}))},507:(e,t)=>{let n;Object.defineProperty(t,"__esModule",{value:!0}),t.Util=void 0;class s{static clamp(e,t,n){return n<t||e<t?t:e>n?n:e}static decodeString(e,t,n){const s=new Uint8Array(e,t,n);let r;for(r=0;r<s.length&&0!==s[r];++r);const i=new Uint8Array(e,t,r);return new TextDecoder("utf-8").decode(i)}static async loadFromServer(e,t=null){const n=await fetch(e,{method:"GET"});return null!=t&&t.binary?await n.arrayBuffer():await n.text()}static encode(e){return(new TextEncoder).encode(e)}static setTerminal(e){n=e}static putTerminal(e){n.session.insert(n.getCursorPosition(),e.toString())}static putTerminalError(e){console.error(e),s.putTerminal(e)}static clearTerminal(){n.setValue("",-1)}}t.Util=s},695:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WaProc=t.ExitCalledError=void 0;const s=n(949),r=n(507);function i(e,t){return e+t-1&-t}class o extends Error{constructor(e){super(`Exit code: ${e}`),this.code=e}}t.ExitCalledError=o,t.WaProc=class{constructor(e){this.breakStartAddress=0,this.breakAddress=0,this.cwd="/",this.fs=new s.FileSystem(e),this.memory=new WebAssembly.Memory({initial:10,maximum:100}),this.imports=this.createImports()}brk(e){if(e>=this.breakStartAddress){if(e>this.memory.buffer.byteLength){const t=e-this.memory.buffer.byteLength,n=Math.floor((t+65536-1)/65536);this.memory.grow(n)}this.breakAddress=e}return this.breakAddress}getAbsPath(e){return e.length>0&&"/"===e[0]?e:`${this.cwd}${"/"===this.cwd?"":"/"}${e}`}chdir(e){this.cwd=e}saveFile(e,t){this.fs.saveFile(this.getAbsPath(e),t)}loadFile(e){return this.fs.loadFile(this.getAbsPath(e))}async runWasmMain(e,t){const n=await this.loadWasm(e),s=this.putArgs(t);return n.exports.main(t.length,s)}async loadWasm(e){let t;if("string"==typeof e)if(WebAssembly.instantiateStreaming)t=await WebAssembly.instantiateStreaming(fetch(e),this.imports);else{const n=await fetch(e),s=await n.arrayBuffer();t=await WebAssembly.instantiate(s,this.imports)}else{if(e.constructor!==Uint8Array)return console.error(`Path or buffer required: ${e}`),null;t=await WebAssembly.instantiate(e,this.imports)}const n=t.instance,s=n.exports.$_SP;return null!=s&&(this.breakStartAddress=this.breakAddress=i(s.valueOf(),8)),n}registerCFunction(e,t){this.imports.c[e]=t}getLinearMemory(){return this.memory}putArgs(e){const t=e.map(r.Util.encode),n=t.reduce(((e,t)=>e+t.length+1),0),s=4*(e.length+1)+n,o=this.breakAddress,a=o+4*(e.length+1);this.brk(i(o+s,8));const l=new Uint32Array(this.memory.buffer,o,e.length+1),c=new Uint8Array(this.memory.buffer,a,n);let u=0;for(let n=0;n<e.length;++n){const e=t[n],s=e.length;for(let t=0;t<s;++t)c[u+t]=e[t];c[u+s]=0,l[n]=a+u,u+=s+1}return l[e.length]=0,o}createImports(){return{c:{read:(e,t,n)=>{const s=new Uint8Array(this.memory.buffer,t,n);return this.fs.read(e,s)},write:(e,t,n)=>{const s=new Uint8Array(this.memory.buffer,t,n);return this.fs.write(e,s)},open:(e,t,n)=>{if(0===e)return-1;const s=r.Util.decodeString(this.memory.buffer,e);if(null==s||""===s)return-1;const i=this.getAbsPath(s);return this.fs.open(i,t,n)},close:e=>this.fs.close(e),lseek:(e,t,n)=>this.fs.lseek(e,t,n),_tmpfile:()=>this.fs.tmpfile(),_brk:e=>this.brk(e),_getcwd:(e,t)=>{const n=r.Util.encode(this.cwd),s=n.length;if(s+1>t)return-34;const i=new Uint8Array(this.memory.buffer,e,s+1);for(let e=0;e<s;++e)i[e]=n[e];return i[s]=0,s+1},sin:Math.sin,cos:Math.cos,sqrt:Math.sqrt,drand48:Math.random,fabs:Math.abs,putsss:e=>{const t=r.Util.decodeString(this.memory.buffer,e);r.Util.putTerminal(t)},puti:e=>{r.Util.putTerminal(e)},exit:e=>{throw new o(e)},_memcpy:(e,t,n)=>{new Uint8Array(this.memory.buffer).copyWithin(e,t,t+n)}},env:{memory:this.memory}}}}}},t={};!function n(s){if(t[s])return t[s].exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}(697)})();